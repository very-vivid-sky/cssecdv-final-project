{{#>adminheader}}
{{/adminheader}}

<div class="container mt-5">
  <div class="row">
    <div class="col-md-12">
      <h1 class="mb-4">Audit Logs</h1>

      <!-- Filter Section -->
      <div class="card mb-4">
        <div class="card-body">
          <form id="filterForm" class="row g-3">
            <div class="col-md-6">
              <label for="actionFilter" class="form-label">Filter by Action</label>
              <select id="actionFilter" class="form-select" name="action">
                <option value="">All Actions</option>
                <option value="LOGIN_SUCCESS">Login Success</option>
                <option value="LOGIN_FAILED">Login Failed</option>
                <option value="ACCOUNT_LOCKED">Account Locked</option>
                <option value="ACCESS_DENIED">Access Denied</option>
                <option value="INVALID_INPUT">Invalid Input</option>
                <option value="PASSWORD_CHANGE">Password Change</option>
                <option value="REGISTRATION">Registration</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="resultFilter" class="form-label">Filter by Result</label>
              <select id="resultFilter" class="form-select" name="result">
                <option value="">All Results</option>
                <option value="success">Success</option>
                <option value="failure">Failure</option>
              </select>
            </div>
            <div class="col-md-12">
              <button type="button" class="btn btn-primary" id="applyFilterBtn">Apply Filter</button>
              <button type="button" class="btn btn-secondary" id="clearFilterBtn">Clear Filter</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Logs Table -->
      <div class="card">
        <div class="card-header">
          <h5>Security Events</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Timestamp</th>
                  <th>User ID</th>
                  <th>Action</th>
                  <th>Result</th>
                  <th>Resource</th>
                  <th>IP Address</th>
                  <th>Error Message</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody id="logsTableBody">
                {{#each logs}}
                <tr>
                  <td>{{formatDate timestamp}}</td>
                  <td>{{userId}}</td>
                  <td>
                    <span class="badge bg-info">{{action}}</span>
                  </td>
                  <td>
                    {{#if (eq result "success")}}
                      <span class="badge bg-success">Success</span>
                    {{else}}
                      <span class="badge bg-danger">Failure</span>
                    {{/if}}
                  </td>
                  <td>{{resource}}</td>
                  <td><code>{{ipAddress}}</code></td>
                  <td>{{errorMessage}}</td>
                  <td>
                    {{#if details}}
                      <small>{{stringify details}}</small>
                    {{else}}
                      <em>â€”</em>
                    {{/if}}
                  </td>
                </tr>
                {{/each}}
              </tbody>
            </table>
          </div>
          {{#if (eq logs.length 0)}}
          <div class="alert alert-info" role="alert">
            No audit logs found.
          </div>
          {{/if}}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.getElementById('applyFilterBtn').addEventListener('click', () => {
    const action = document.getElementById('actionFilter').value;
    const result = document.getElementById('resultFilter').value;
    
    const params = new URLSearchParams();
    if (action) params.append('action', action);
    if (result) params.append('result', result);
    
    window.location.href = `/logs?${params.toString()}`;
  });

  document.getElementById('clearFilterBtn').addEventListener('click', () => {
    window.location.href = '/logs';
  });
</script>