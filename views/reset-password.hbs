{{>guestheader}}

<body class="d-flex flex-column min-vh-100">
  <section class="container column my-3">
    <div>
      <h1>Reset Password</h1>
    </div>
    
    {{#if message}}
    <div class="alert {{#if (eq step 'verify')}}alert-warning{{else}}alert-danger{{/if}}" role="alert">
      <strong>{{message}}</strong>
    </div>
    {{/if}}

    <div class="my-2 mx-3">

      {{#eq step "identify"}}
        <!-- Step 1: Enter email -->
        <form method="POST" action="/reset-password" class="form vstack login-form gap-2">
          <input type="hidden" name="step" value="identify">
          
          <p class="text-muted">Enter your email address and we'll show you security questions to verify your identity.</p>
          
          <label class="form-label">Email Address</label>
          <input type="email" name="email" placeholder="Enter your email" class="form-control" required autofocus>
          
          <button type="submit" class="btn btn-primary mt-2">Continue</button>
        </form>
        
        <div class="mt-3">
          <a href="/login">Back to Login</a>
        </div>

      {{else if (eq step "verify")}}
        <!-- Step 2: Answer security questions and set new password -->
        <form method="POST" action="/reset-password" class="form vstack login-form gap-2">
          <input type="hidden" name="step" value="verify">
          <input type="hidden" name="email" value="{{email}}">
          
          <p class="text-muted">Answer your security questions to reset your password.</p>
          
          {{#if questions}}
            {{#each questions}}
              <div class="mb-3">
                <label class="form-label"><strong>Question {{@index 1}}:</strong> {{this.question}}</label>
                <input type="text" name="answer{{@index 1}}" placeholder="Your answer" class="form-control" required>
              </div>
            {{/each}}
          {{else}}
            <div class="alert alert-danger">
              No security questions found for this account. Please contact support.
            </div>
          {{/if}}
          
          <hr class="my-3">
          
          <p class="text-muted"><strong>Enter your new password:</strong></p>
          
          <label class="form-label">New Password</label>
          <input type="password" name="newPassword" placeholder="New password" class="form-control" required>
          <small class="text-muted">At least 8 characters with uppercase, lowercase, number, and special character.</small>
          
          <label class="form-label mt-2">Confirm Password</label>
          <input type="password" name="confirmPassword" placeholder="Confirm password" class="form-control" required>
          
          <button type="submit" class="btn btn-primary mt-2">Reset Password</button>
        </form>
        
        <div class="mt-3">
          <a href="/reset-password">Start Over</a>
        </div>

      {{else if (eq step "success")}}
        <!-- Step 3: Success message -->
        <div class="alert alert-success" role="alert">
          <h4 class="alert-heading">Password Reset Successful!</h4>
          <p>Your password has been successfully reset. You can now log in with your new password.</p>
          <hr>
          <p class="mb-0"><a href="/login" class="btn btn-success">Go to Login</a></p>
        </div>

      {{/if}}

    </div>
  </section>
</body>
